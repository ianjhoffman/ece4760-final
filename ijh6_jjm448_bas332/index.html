<!DOCTYPE html>
<html>

<head>
	<title>Final Project Report - Wavetable Synthesizer</title>
	<link rel="stylesheet" href="style/default_style.css">
	<link rel="stylesheet" href="style/style.css">
	<link rel="icon" href="images/favicon.ico">
	<meta charset="UTF-8">
	<meta name="description" content="ECE 4760 Project by Ian Hoffman (ijh6), Joval Mathew (jjm448), and Balazs Szegletes (bas332)">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
</head>

<body>
	<!-- TOP OF PAGE -->
	<div id="top"></div>

	<!-- PAGE HEADER -->
	<h1 id="title">
		ECE 4760 Final Project Report <br>
		Programmable Sequenced Wavetable Synthesizer

		<!-- IMAGES IN HEADER -->
		<img src="images/header_img_1.png" alt="waveform1" class="top-img" style="left: 7.5px;">
		<img src="images/header_img_2.png" alt="waveform2" class="top-img" style="right: 7.5px;">
	</h1>

	<br>

	<!-- AUTHORS -->
	<h2 class="section-header">Authors</h2>
	<br>
	<ul id="authors">
		<li>
			Ian Hoffman (ijh6)
		</li>
		<li>
			Joval Mathew (jjm448)
		</li>
		<li>
			Balazs Szegletes (bas332)
		</li>
	</ul>

	<br>

	<!-- PAGE TABLE OF CONTENTS -->
	<h2 class="section-header">Table of Contents</h2>
	<br>
	<ul id="table-of-contents">
		<li>
			<a href="#introduction">Introduction</a>
		</li>
		<li>
			<a href="#high-level">High-Level Design</a>
		</li>
		<li>
			<a href="#hardware-software-design">Hardware/Software Design</a>
		</li>
		<li>
			<a href="#results">Results</a>
		</li>
		<li>
			<a href="#conclusion">Conclusion</a>
		</li>
		<li>
			<a href="#appendix-a">Appendix A</a>
		</li>
		<li>
			<a href="#commented-program">Commented Program Files</a>
		</li>
		<li>
			<a href="#schematics">Schematics</a>
		</li>
		<li>
			<a href="#cost-details">Cost Details</a>
		</li>
		<li>
			<a href="#member-roles">Member Roles</a>
		</li>
		<li class="list-last">
			<a href="#references">References</a>
		</li>
	</ul>

	<br>
	<br>
	<br>

	<!-- PAGE SECTIONS -->
	<h2 class="section-header" id="introduction">Introduction</h2>
	<div class="report-section">
		<h3 class="subsection-header"> Soundbite </h3>
		<div class="subsection-content">
			For our final project, we created a wavetable synthesizer capable of playing back short user-programmable
			sequences with a large range of timbres.
		</div>
		<br>

		<h3 class="subsection-header"> Summary </h3>
		<div class="subsection-content">
			We decided to create a fun, easy-to-use wavetable synthesizer with just enough parameters 
			to offer a large sonic range, while limiting the controls to keep the user interface clean and 
			as unconfusing as possible. This goal was driven by the desire to make a useful product relevant 
			to the current digital synthesizer market, an area in which wavetable synthesis is very popular. 
			This method of synthesis allows for arbitrary waveforms, as well as blends of multiple waveforms, 
			allowing for a number of tones only limited by the storage capacity of the device. 
		</div>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- HIGH-LEVEL DESIGN -->
	<h2 class="section-header" id="high-level">High-Level Design</h2>
	<div class="report-section">
		<h3 class="subsection-header"> Rationale </h3>
		<div class="subsection-content">
			rationale text...
		</div>
		<br>

		<h3 class="subsection-header"> Logical Structure </h3>
		<div class="subsection-content">
			logical structure text...
		</div>
		<br>

		<h3 class="subsection-header"> Hardware/Software Tradeoffs </h3>
		<div class="subsection-content">
			hardware/software tradeoffs text...
		</div>
		<br>

		<h3 class="subsection-header"> Use of Existing Standards </h3>
		<div class="subsection-content">
			We did not use any common standards for this project. One possible standard we
			could have used, has this been a keyboard-controlled synthesizer, would be MIDI.
			However, since we generate and modify our 16-step sequence internally, it does
			not make sense to use the MIDI standard to represent note onsets, offsets, and
			pitches.
		</div>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- HARDWARE/SOFTWARE DESIGN -->
	<h2 class="section-header" id="hardware-software-design">Hardware/Software Design</h2>
	<div class="report-section">
		<h3 class="subsection-header"> Software Details </h3>
		<div class="subsection-content">

			<h4 class="subsubsection-header"> Synthesis/Sequencer Parameters </h4>

			In our software, there are dozens of variables that refer to different synthesis
			parameters. Two char arrays, step_notes and steps_on, represent the note and
			activity (rest or note) of each step in the 16-step sequence. In step_notes, a
			note is represented by an index, 0-48, into a table of phase accumulators, 
			calculated using freq_accum_calcs.rb, which can be found in the 
			<a class="external" href="#commented-program">Commented Program Files</a> section.

			<br><br>

			The old_step_select, step_select, note_select, old_step, and curr_step variables
			are used for sequence editing and playback, both to supply the TFT-update thread
			with information it needs to draw the sequence state, and to facilitate reading
			and writing data to/from the two sequence arrays mentioned above. The seq_active
			variable is used in the DDS ISR to determine whether or not to add the sequence
			advancing phase accumulator to the step_accum counter. The phase accumulators for
			each tempo were calculated using tempo_accum_calcs.rb, which can be found in the
			Commented Program Files section.

			<br><br>

			There are many flags, accumulators, and values that go into making the amplitude
			and shape blend envelopes work. The amp_env, shape_env, and shape_amt variables
			hold the values for the modal envelopes, and the attenuation amount for the shape
			envelope respectively, all set directly from the ADC reading thread. The rising
			variables are used as flags in the DDS ISR to determine whether to add or subtract
			the accumulator. The rise_acc and fall_acc variables for both envelopes are set 
			using envelope rise/fall phase accumulators calculated in env_bound_accum_calcs.rb, 
			which can be found in the Commented Program Files section. These accumulators are 
			blended across the turn of the modal envelope knobs, allowing fades through 
			different envelope lengths and shapes.

			<br><br> 

			Both envelopes are AD envelopes. At the left side of the knob, the envelope has
			a short attack and long decay. As the knob moves towards the center of its turn, 
			the decay becomes longer until a certain keyframe, at which point the attack
			starts lengthening, making the envelope's shape more triangular. After this 
			keyframe, the attack continues to become longer as the decay shortens, eventually
			resulting in shapes inverse to those on the left side of the knob, in which the
			attack is long but the decay is very short. The specific time values of each
			envelope keyframe are listed in comments in env_bound_accum_calcs.rb.

			<br><br>
			<h4 class="subsubsection-header"> DDS ISR </h4> 

			Our DDS ISR (Direct Digital Synthesis Interrupt Service Routine) accomplishes
			all the tasks it needs to very expediently. This is necessary because of the speed
			at which it is run: 100kHz. In these 400 cycles, with cycles to spare for other
			threads like the button or TFT threads, 

			<br><br>
			<h4 class="subsubsection-header"> TFT/User Interface </h4> 


			<br><br>
			<h4 class="subsubsection-header"> Multiplexing Input </h4>


			<br><br>
			<h4 class="subsubsection-header"> Button Processing </h4>


			<br><br>
			<h4 class="subsubsection-header"> Creating Wavetables </h4>


			<br><br>
			<h4 class="subsubsection-header"> Use of unsigned ints instead of fix16 </h4>

		</div>
		<br>

		<h3 class="subsection-header"> Hardware Details </h3>
		<div class="subsection-content">
			The hardware for the synthesizer is composed of a PIC32 microcontroller, 
			7 potentiometers, 4 buttons, an 8:1 analog multiplexer, a 12-bit DAC, 
			and a TFT display. Using user input from the various potentiometers and 
			buttons, the PIC then generates different sequences and waveforms based 
			upon the current inputs. 

			<br><br>

			A full hardware diagram can be found in the 
			<a class="external" href="#schematics">Schematics</a> 
			section.

			<br><br>

			Our TFT display is connected the way it has been for the previous labs, 
			using pins 4, 5, 6, 22, and 25. 

			<br><br>

			<!-- CONTROL FUNCTION TABLE -->
			<h3 class="diagram-label"> Button/Knob Control Functions </h3>
			<img src="images/control_uses.png" alt="controls" class="diagram-img">

			<!-- PIN CONNECTIONS TABLE -->
			<h3 class="diagram-label"> Pin Connections </h3>
			<img src="images/pin_connex.png" alt="connections" class="diagram-img">

			<br>

			The PIC32 then used direct digital synthesis running at 100 kHz to generate 
			the correct waveform specified by the input settings. The generation of  
			the waveform required the use of an external 12-bit DAC, the MCP4822.  
			The DAC has two output pins, VoutA and VoutB, of which we only use VoutA.  
			VoutB is sent to ground, along with Vss, and the LDAC pins. 

			 <br><br>

			The DAC is responsible for the main deliverable portion of our project, 
			so its function is quite visible. However, the other main bit of 
			hardware in our setup is the CD4051B multiplexer, which takes input 
			signals from all of our potentiometers and relieves pressure on the PIC32’s 
			ADC capabilities. Most of the ADC pins on the PIC32 are taken up by the 
			TFT display, and so only four pins exist for our 7 analog inputs. 
			Clearly, even if we were to use all the ADC inputs, there would be a need 
			for multiplexing, as there would be three knobs unconnected. If we were 
			to use multiple ADC pins, then we would also have to re-configure the 
			ADC setup in order to multiplex between all the ADC pins. 

			<br><br>

			Under the hood, there exists only one ADC in the microcontroller, so it 
			would be multiplexing between all of the ADC pins, in addition to the 
			multiplexing we would be doing on each pin. The CD4051B perfectly addresses 
			this issue, due to it having eight inputs, outputting a single signal which 
			we could read on the one ADC pin on the PIC32. Thanks to the multiplexer, 
			we can keep the existing ADC configuration. Although the multiplexer requires 
			three extra channel inputs, which are controlled by the PIC32, we have plenty 
			more options with it, seeing as they can be digital outputs. The multiplexer 
			takes Vdd from the PIC32 power rail, and uses all the signal input pins except 
			for Signal 5, which we grounded. The Vss, Vee, and INH pins were also sent 
			to ground. 

			<br><br>

			In order to stabilize the voltage output by the PIC32, we placed various 10µF 
			capacitors between power and ground on the hardware. This smoothes out 
			spikes and drops in the 3.3V output of the microcontroller. 

		</div>
		<br>

		<h3 class="subsection-header"> Preexisting Code </h3>
		<div class="subsection-content">
			All of the preexisting code we used was boilerplate code from the ECE 4760
			course website for setting up ISRs, DACs, I/O pins, and timers. We also 
			used the <a class="external" href="http://dunkels.com/adam/pt/"> Protothreads 
			</a> library by Adam Dunkels, and the tft_master.c/tft_gfx.c libraries 
			provided by Professor Land.
		</div>
		<br>

		<h3 class="subsection-header"> Roadblocks </h3>
		<div class="subsection-content">
			The most vexing bottleneck in our project was getting the multiplexer to work 
			properly. After wiring it up according to the data sheet, it would only function 
			intermittently, working properly sometimes, and then being completely unresponsive 
			at others. In addition to this, when the hardware did function, a few potentiometer 
			inputs seemed to interact with others. Specifically, the first signal input would 
			be altered slightly by every other knob, and the sixth knob would bleed into all 
			other inputs. Since the multiplexer would work sporadically and unpredictably, it didn’t 
			seem as if software was the issue, though it was possible. When touching and bending 
			wires, we would occasionally be able to change the functionality of multiplexer, but 
			these events would not affect the multiplexer consistently. 

			<br><br>

			One possible explanation for 
			this behavior takes into account the electric fields our bodies generate. 
			Depending on where we would poke wires and our own orientation, the multiplexer signal 
			wires could have been affected. This issue could be exacerbated by the fact 
			that we had channel select wires crossing over the analog outputs of the multiplexer, 
			which were both in close proximity to our power rails. This served as part of 
			the motivation to move our hardware setup to perfboard. To further address 
			the signal-to-noise issue, we placed capacitors between power and ground, and moved 
			wires away from the TFT display. In case of internally broken wires, we also 
			replaced all the signal wires connecting to the multiplexer. In order to address the 
			possible internal signal bleeding of the multiplexer, we grounded pin 5 of the multiplexer,
			which equated to the 6th signal input, the multiplexer pins being 0-indexed.

			<br><br>

			After taking all the actions listed above, the multiplexer behaved more consistently, but 
			we were unable to read from more than 2 different sources, beyond which we received
			garbage data. This issue this time was a software issue; we weren’t waiting 
			long enough between switching index bits to read the ADC pin. The PIC’s <i>DigitalRead</i>
			settling time, internal ADC sampling speeds, and the multiplexer’s switching speed require 
			dozens of processor cycles of waiting, so we put in a delay of approximately a microsecond 
			before each read. The function for waiting 1µs included in the TFT library was not working
			for some reason, so this wait was achieved using a for loop with no body.

			<br><br>

			Carrying out these fixes largely took care of all the issues we were seeing. Because we 
			implemented most of these methods in parallel, we were unable to isolate 
			one particular root cause of the malfunctioning, but taken together, 
			we would say that the issues were some combination of the challenges 
			mentioned above. 

			<br><br>

			Another issue that was present throughout much of the project was the random 
			appearance of white dots on the TFT display. Over time after power-on, pixels 
			that should have stayed black would become white.The code never 
			called for white dots to be printed, so we couldn’t isolate the error. Our first 
			fix to this problem was to write a segment of the screen black every 10 seconds. 
			However, this was a purely aesthetic fix, which did not remove the underlying
			problem.

			<br><br>

			Eventually, we realized that putting our sequencer's active-step TFT updates in an ISR 
			to achieve a constant, fast update at high tempos was the root of the problem. Since
			we had TFT updates in this ISR, and in a separate thread used to update more slowly-
			updating parts of the UI, there were many scheduling scenarios in which the serial data
			sent to the TFT was corrupted. In some instances, this conflict would cause the PIC32
			to crash entirely. After realizing the origin of our problem, we moved all TFT updates
			to a single thread. This thread ran at 15-20 fps, and due to the less-frequent update,
			our sequencer's active-step readout could be jumpy at certain sequence speeds. However, 
			we gained overall performance by eliminating this potentially fatal stress on the serial
			data bus.
		</div>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- RESULTS OF PROJECt -->
	<h2 class="section-header" id="results">Results</h2>
	<div class="report-section">

		<iframe src="https://www.youtube.com/embed/-MwzoiNMvcI" class="video" frameborder="0" allowfullscreen>
		</iframe><br>

		<h3 class="subsection-header"> Wave Tables </h3>
		<div class="subsection-content">
			wave table images here
		</div>
		<br>

		<h3 class="subsection-header"> Oscilloscope Captures </h3>
		<div class="subsection-content">
			scope shots here
		</div>
		<br>

		<h3 class="subsection-header"> Speed and Responsiveness </h3>
		<div class="subsection-content">
			analysis of speed and responsiveness here
		</div>
		<br>

		<h3 class="subsection-header"> Safety </h3>
		<div class="subsection-content">
			safety considerations here
		</div>
		<br>

		<h3 class="subsection-header"> Usability </h3>
		<div class="subsection-content">
			usability considerations here
		</div>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- CONCLUSION SECTION -->
	<h2 class="section-header" id="conclusion">Conclusion</h2>
	<div class="report-section">
		<h3 class="subsection-header"> Conformity to Initial Specification </h3>
		<div class="subsection-content">
			how different was our end product from original plan? what changes did we make?
		</div>
		<br>

		<h3 class="subsection-header"> Future Ideas </h3>
		<div class="subsection-content">
			things we would have liked to implement, had we had more time...
		</div>
		<br>

		<h3 class="subsection-header"> Intellectual Property Considerations </h3>
		<div class="subsection-content">
			intellectual property considerations text...
		</div>
		<br>

		<h3 class="subsection-header"> Ethical Considerations </h3>
		<div class="subsection-content">
			200 words or more, in reference to
			<a href="http://www.ieee.org/web/membership/ethics/code_ethics.html" class="external">
				IEEE code of ethics
			</a>
		</div>
		<br>

		<h3 class="subsection-header"> Legal Considerations </h3>
		<div class="subsection-content">
			legal considerations text...
		</div>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- APPENDIX A -->
	<h2 class="section-header" id="appendix-a">Appendix A</h2>
	<div class="report-section">
		The group approves this report and the YouTube video for inclusion on the course website.

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- IMPORTANT PROGRAM FILES (ANNOTATED) -->
	<h2 class="section-header" id="commented-program">Commented Program Files</h2>
	<div class="report-section">
		<ul id="code-links">
			<li><a href="code/wavetable_master.c">
				wavetable_master.c <i> (main firmware file) </i>
			</a></li>
			<li><a href="code/convert.cpp">
				convert.cpp <i> (raw 32-bit binary audio to wavetable header conversion) </i>
			</a></li>
			<li><a href="code/env_bound_accum_calcs.rb">
				env_bound_accum_calcs.rb <i> (envelope keyframe phase accumulator calculations) </i>
			</a></li>
			<li><a href="code/freq_accum_calcs.rb">
				freq_accum_calcs.rb <i> (frequency phase accumulator calculations) </i>
			</a></li>
			<li><a href="code/tempo_accum_calcs.rb">
				tempo_accum_calcs.rb <i> (tempo phase accumulator calculations) </i>
			</a></li>
		</ul>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- BUILD SCHEMATICS -->
	<h2 class="section-header" id="schematics">Schematics</h2>
	<div class="report-section">
		<!-- HARDWARE/CIRCUIT DIAGRAM -->
		<h3 class="diagram-label"> Hardware/Circuit Diagram </h3>
		<img src="images/hardware_schematic.png" alt="circuit diagram" class="diagram-img">

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- COSTS/BOM -->
	<h2 class="section-header" id="cost-details">Cost Details</h2>
	<div class="report-section">
		<b> Bill of Materials: </b>
		<br><br>

		<ul id="costs">
			<li> MicroStickII <b> ($10.00) </b> </li>
			<li> TFT LCD Display <b> ($10.00) </b> </li>
			<li> Solder Board x 2 <b> ($5.00) </b> </li>
			<li> Lab Speakers <b> ($2.00) </b> </li>
			<li> Tactile Switch x 4 <i> (Apem, Digikey Part #679-2428-ND) </i> <b> ($0.37) </b> </li>
			<li> Linear 10k Potentiometer x 7 <i> (TT Electronics/BI, Digikey Part #987-1277-ND) </i> <b> ($4.34) </b> </li>
			<li> MCP4822 12-Bit DAC <i> (Microchip Technology, Digikey Part #MCP4822-E/P-ND) </i> <b> ($3.00) </b> </li>
			<li> CD4051BE 8:1 Multiplexer <i> (Texas Instruments, Digikey Part #296-2057-5-ND) </i> <b> ($0.52) </b> </li>
		</ul>
		<br>

		<p>
			&nbsp; &nbsp;
			<b> Total cost: </b> $35.23
		</p>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- MEMBER ROLES -->
	<h2 class="section-header" id="member-roles">Member Roles</h2>
	<div class="report-section">
		<p>
			<b> Ian Hoffman </b> (ijh6)
			<br>
			<ul class="roles-list">
				<li> Software Development Lead </li>
				<li> Wavetable Creation/File Conversion </li>
				<li> Synthesis Parameter Calculation Scripting </li>
				<li> Diagramming </li>
				<li> Web Development </li>
			</ul>
		</p>
		<br>

		<p>
			<b> Joval Mathew </b> (jjm448)
			<br>
			<ul class="roles-list">
				<li> Hardware Prototyping/Design </li>
				<li> Board Layout/Soldering </li>
				<li> Software Development </li>
				<li> Project Organization and Management </li>
			</ul>
		</p>
		<br>

		<p>
			<b> Balazs Szegletes </b> (bas332)
			<br>
			<ul class="roles-list">
				<li> Hardware Prototyping/Design </li>
				<li> Board Layout/Soldering </li>
			</ul>
		</p>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>

	<!-- REFERENCES (MANUALS, ETC.) -->
	<h2 class="section-header" id="references">References</h2>
	<div class="report-section">
		<ul id="references">
			<li><a href="http://www.ti.com/lit/ds/symlink/cd4051b.pdf">
				Multiplexer Datasheet
			</a></li>
			<li><a href="http://people.ece.cornell.edu/land/courses/ece4760/labs/f2016/lab2_mcp4822.pdf"> 
				DAC Datasheet 
			</a></li>
			<li><a href="https://people.ece.cornell.edu/land/courses/ece4760/StudentWork/McNicoll/PIC32_Pinout_brl.pdf">
				PIC32 Pinout Diagram
			</a></li>
			<li><a href="http://ww1.microchip.com/downloads/en/DeviceDoc/32bitPeripheralLibraryGuide.pdf">
				PIC32 Peripheral Libraries Guide
			</a></li>
			<li><a href="http://www.microchip.com/design-centers/32-bit">
				PIC32 Reference Manual
			</a></li>
			<li><a href="https://people.ece.cornell.edu/land/courses/ece4760/PIC32/index_Protothreads.html">
				Protothreads on PIC32
			</a></li>
		</ul>

		<!-- LINK TO TOP OF PAGE -->
		<a href="#top" class="top-link">TOP</a>
	</div>
</body>

</html>